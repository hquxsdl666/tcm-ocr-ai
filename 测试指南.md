# 中药方剂 OCR APP - 测试指南

## 🔴 HTTP 401 错误解决方案

如果您遇到 HTTP 401 错误，说明 API Key 有问题。请按以下步骤排查：

### 1. 检查 API Key 来源

**正确来源**: https://platform.moonshot.cn (Kimi/Moonshot)

**错误来源**: 
- ❌ https://platform.deepseek.com (DeepSeek)
- ❌ https://openai.com (OpenAI)

### 2. API Key 格式检查

正确的 Kimi API Key 格式：
```
sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

- 必须以 `sk-` 开头
- 长度约 40-50 个字符

### 3. 快速测试 API Key

#### 方法一：使用 Python 脚本（推荐）

```bash
# 安装依赖
pip install requests

# 运行测试
python test_kimi_api.py

# 或直接在命令行传入 API Key
python test_kimi_api.py sk-your-api-key-here
```

#### 方法二：使用 curl

```bash
# 替换 sk-xxxx 为您的实际 API Key
curl https://api.moonshot.cn/v1/models \
  -H "Authorization: Bearer sk-xxxx"
```

如果返回模型列表，说明 API Key 有效。

#### 方法三：在 GitHub Actions 中测试

1. 打开 https://github.com/hquxsdl666/tcm-ocr-ai/actions
2. 选择 "Test Kimi API" 工作流
3. 点击 "Run workflow"
4. 输入您的 API Key
5. 点击 "Run workflow"

---

## 🧪 功能测试清单

### OCR 识别功能测试

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击首页 "OCR识别" | 进入相机界面 |
| 2 | 拍摄一张药方照片 | 显示裁剪/确认界面 |
| 3 | 确认图片 | 显示识别中的加载动画 |
| 4 | 等待识别完成 | 显示药材列表、剂量、用法 |
| 5 | 点击保存 | 药方保存到历史记录 |

### AI 助手功能测试

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 首次进入 AI 助手 | 弹出 API Key 输入框 |
| 2 | 输入正确的 Kimi API Key | 保存成功，无错误提示 |
| 3 | 发送消息 "你好" | AI 正常回复 |
| 4 | 发送 "分析当归的功效" | 返回当归的药效分析 |
| 5 | 点击右上角 "AI开方" | 弹出症状输入对话框 |
| 6 | 输入症状并提交 | 返回方剂推荐 |

---

## 🔧 本地编译测试

### 环境要求

- Android Studio Hedgehog (2023.1.1) 或更高版本
- JDK 17
- Android SDK 34

### 编译步骤

```bash
cd android-app

# Windows
.\gradlew.bat assembleDebug

# Mac/Linux
./gradlew assembleDebug
```

APK 输出位置：`app/build/outputs/apk/debug/app-debug.apk`

---

## 🐛 常见问题

### 问题1: HTTP 401 Unauthorized

**原因**: API Key 无效或过期
**解决**: 
1. 访问 https://platform.moonshot.cn
2. 检查 API Key 是否有效
3. 重新创建 API Key

### 问题2: HTTP 404 Not Found

**原因**: API 端点配置错误（已修复）
**状态**: ✅ 已在最新版本中修复

### 问题3: 网络超时

**原因**: 网络连接问题或 API 响应慢
**解决**: 
1. 检查网络连接
2. 稍后重试
3. 检查是否使用了 VPN/代理

### 问题4: JSON 解析错误

**原因**: AI 返回的内容格式不符合预期
**解决**: 重试，或简化问题描述

---

## 📱 真机测试建议

1. **Android 版本**: Android 8.0 (API 26) 及以上
2. **权限检查**:
   - 相机权限（用于 OCR 拍照）
   - 存储权限（用于保存图片）
   - 网络权限（用于 AI 对话）

3. **测试设备建议**:
   - 不同 Android 版本（8/10/12/14）
   - 不同屏幕尺寸（手机/平板）
   - 不同网络环境（WiFi/4G/5G）

---

## 📝 反馈问题

如果问题仍未解决，请提供以下信息：

1. APP 版本号（设置 → 关于）
2. Android 版本
3. 错误截图
4. 复现步骤
5. 使用的 API Key 前缀（如 `sk-abc...`，隐藏中间部分）
